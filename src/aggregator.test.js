import { describe, expect, it } from "vitest";
import { tradeAggregator } from "./aggregator";

describe("Testing Trade Cases", () => {
  it("Unfinished trade", () => {
    const rawTrades = [
      {
        symbol: "ARUSDT",
        id: 23412453,
        orderId: 479800135,
        side: "BUY",
        price: "58.770",
        qty: "1.6",
        realizedPnl: "0",
        marginAsset: "USDT",
        quoteQty: "94.0320",
        commission: "0.01880640",
        commissionAsset: "USDT",
        time: 1640926394114,
        positionSide: "BOTH",
        buyer: true,
        maker: true,
      },
    ];
    const trades = tradeAggregator(rawTrades);
    expect([]).eql(trades);
  });

  it("Flip trade", () => {
    const rawTrades = [
      {
        symbol: "1000SHIBUSDT",
        id: 421178634,
        orderId: 4997953617,
        side: "BUY",
        price: "0.038400",
        qty: "1000",
        realizedPnl: "0",
        marginAsset: "USDT",
        quoteQty: "38.400000",
        commission: "0.00768000",
        commissionAsset: "USDT",
        time: 1640341654465,
        positionSide: "BOTH",
        buyer: true,
        maker: true,
      },
      {
        symbol: "1000SHIBUSDT",
        id: 421178785,
        orderId: 4997956582,
        side: "SELL",
        price: "0.038416",
        qty: "2000",
        realizedPnl: "0.01600000",
        marginAsset: "USDT",
        quoteQty: "76.832000",
        commission: "0.01536640",
        commissionAsset: "USDT",
        time: 1640341672566,
        positionSide: "BOTH",
        buyer: false,
        maker: true,
      },
      {
        symbol: "1000SHIBUSDT",
        id: 421179162,
        orderId: 4997961295,
        side: "BUY",
        price: "0.038408",
        qty: "1000",
        realizedPnl: "0.00800000",
        marginAsset: "USDT",
        quoteQty: "38.408000",
        commission: "0.00768160",
        commissionAsset: "USDT",
        time: 1640341742230,
        positionSide: "BOTH",
        buyer: true,
        maker: true,
      },
    ];
    const trades = tradeAggregator(rawTrades);
    expect(trades).eql([
      {
        openTime: 1640341654465,
        closeTime: 1640341672566,
        symbol: "1000SHIBUSDT",
        side: "LONG",
        priceOpen: "$0.0384",
        priceClose: "$0.038416",
        quantity: "1000",
        fee: "$0.02",
        profit: "-$0.01",
        priceChangeInPercent: "0.04%",
        volume: "$38.40",
      },
      {
        openTime: 1640341672566,
        closeTime: 1640341742230,
        symbol: "1000SHIBUSDT",
        side: "SHORT",
        priceOpen: "$0.038416",
        priceClose: "$0.038408",
        quantity: "1000",
        fee: "$0.01",
        profit: "$0.00",
        priceChangeInPercent: "0.02%",
        volume: "$38.42",
      },
    ]);
  });

  it("Close an unknown trade and open a new one", () => {
    const rawTrades = [
      {
        symbol: "IOTXUSDT",
        id: 64831660,
        orderId: 886898697,
        side: "SELL",
        price: "0.14087",
        qty: "1500",
        realizedPnl: "1.68000000", // non-zero Pnl means that there is a deal to close the previous trade
        marginAsset: "USDT",
        quoteQty: "211.30500",
        commission: "0.08452200",
        commissionAsset: "USDT",
        time: 1640585325793,
        positionSide: "BOTH",
        buyer: false,
        maker: false,
      },
      {
        symbol: "IOTXUSDT",
        id: 64868494,
        orderId: 887700390,
        side: "BUY",
        price: "0.14540",
        qty: "250",
        realizedPnl: "0",
        marginAsset: "USDT",
        quoteQty: "36.35000",
        commission: "0.00727000",
        commissionAsset: "USDT",
        time: 1640599699242,
        positionSide: "BOTH",
        buyer: true,
        maker: true,
      },
      {
        symbol: "IOTXUSDT",
        id: 64948667,
        orderId: 889339356,
        side: "SELL",
        price: "0.14776",
        qty: "250",
        realizedPnl: "0.63166666",
        marginAsset: "USDT",
        quoteQty: "36.94000",
        commission: "0.01477600",
        commissionAsset: "USDT",
        time: 1640618948051,
        positionSide: "BOTH",
        buyer: false,
        maker: false,
      },
    ];
    const trades = tradeAggregator(rawTrades);
    expect(trades).eql([
      {
        closeTime: 1640618948051,
        fee: "$0.02",
        openTime: 1640599699242,
        priceChangeInPercent: "1.62%",
        priceClose: "$0.14776",
        priceOpen: "$0.1454",
        profit: "$0.61",
        quantity: "250",
        side: "LONG",
        symbol: "IOTXUSDT",
        volume: "$36.35",
      },
    ]);
  });

  it("Losing trade to buy", () => {
    const rawTrades = [
      {
        symbol: "NKNUSDT",
        id: 57856665,
        orderId: 1243901519,
        side: "BUY",
        price: "0.38080",
        qty: "132",
        realizedPnl: "0",
        marginAsset: "USDT",
        quoteQty: "49.92240",
        commission: "0.00998448",
        commissionAsset: "USDT",
        time: 1640945904886,
        positionSide: "BOTH",
        buyer: true,
        maker: true,
      },
      {
        symbol: "NKNUSDT",
        id: 57858773,
        orderId: 1243921202,
        side: "SELL",
        price: "0.37820",
        qty: "132",
        realizedPnl: "-0.34320000",
        marginAsset: "USDT",
        quoteQty: "50.26560",
        commission: "0.01005312",
        commissionAsset: "USDT",
        time: 1640947616268,
        positionSide: "BOTH",
        buyer: false,
        maker: true,
      },
    ];
    const trades = tradeAggregator(rawTrades);
    expect(trades).eql([
      {
        closeTime: 1640947616268,
        fee: "$0.02",
        openTime: 1640945904886,
        priceChangeInPercent: "-0.69%",
        priceClose: "$0.3782",
        priceOpen: "$0.3808",
        profit: "-$0.36",
        quantity: "132",
        side: "LONG",
        symbol: "NKNUSDT",
        volume: "$50.27",
      },
    ]);
  });

  it("Losing trade to sell", () => {
    const rawTrades = [
      {
        symbol: "SXPUSDT",
        id: 195501326,
        orderId: 8095119826,
        side: "SELL",
        price: "1.8480",
        qty: "26.3",
        realizedPnl: "0",
        marginAsset: "USDT",
        quoteQty: "49.04424",
        commission: "0.01961769",
        commissionAsset: "USDT",
        time: 1640871981131,
        positionSide: "BOTH",
        buyer: false,
        maker: false,
      },
      {
        symbol: "SXPUSDT",
        id: 195509438,
        orderId: 8095086377,
        side: "BUY",
        price: "1.8648",
        qty: "26.3",
        realizedPnl: "-0.36907666",
        marginAsset: "USDT",
        quoteQty: "48.60240",
        commission: "0.00972048",
        commissionAsset: "USDT",
        time: 1640872032348,
        positionSide: "BOTH",
        buyer: true,
        maker: true,
      },
    ];
    const trades = tradeAggregator(rawTrades);
    expect(trades).eql([
      {
        closeTime: 1640872032348,
        fee: "$0.03",
        openTime: 1640871981131,
        priceChangeInPercent: "-0.91%",
        priceClose: "$1.8648",
        priceOpen: "$1.848",
        profit: "-$0.40",
        quantity: "26.3",
        side: "SHORT",
        symbol: "SXPUSDT",
        volume: "$48.60",
      },
    ]);
  });

  it("Profitable trade to buy", () => {
    const rawTrades = [
      {
        symbol: "NKNUSDT",
        id: 57856665,
        orderId: 1243901519,
        side: "BUY",
        price: "0.37820",
        qty: "132",
        realizedPnl: "0",
        marginAsset: "USDT",
        quoteQty: "49.92240",
        commission: "0.00998448",
        commissionAsset: "USDT",
        time: 1640945904886,
        positionSide: "BOTH",
        buyer: true,
        maker: true,
      },
      {
        symbol: "NKNUSDT",
        id: 57858773,
        orderId: 1243921202,
        side: "SELL",
        price: "0.38080",
        qty: "132",
        realizedPnl: "0.34320000",
        marginAsset: "USDT",
        quoteQty: "50.26560",
        commission: "0.01005312",
        commissionAsset: "USDT",
        time: 1640947616268,
        positionSide: "BOTH",
        buyer: false,
        maker: true,
      },
    ];
    const trades = tradeAggregator(rawTrades);
    expect(trades).eql([
      {
        closeTime: 1640947616268,
        fee: "$0.02",
        openTime: 1640945904886,
        priceChangeInPercent: "0.69%",
        priceClose: "$0.3808",
        priceOpen: "$0.3782",
        profit: "$0.32",
        quantity: "132",
        side: "LONG",
        symbol: "NKNUSDT",
        volume: "$49.92",
      },
    ]);
  });

  it("Profitable trade to sell", () => {
    const rawTrades = [
      {
        symbol: "SXPUSDT",
        id: 195501326,
        orderId: 8095119826,
        side: "SELL",
        price: "1.8648",
        qty: "26.3",
        realizedPnl: "0",
        marginAsset: "USDT",
        quoteQty: "49.04424",
        commission: "0.01961769",
        commissionAsset: "USDT",
        time: 1640871981131,
        positionSide: "BOTH",
        buyer: false,
        maker: false,
      },
      {
        symbol: "SXPUSDT",
        id: 195501636,
        orderId: 8095121558,
        side: "SELL",
        price: "1.8641",
        qty: "26.3",
        realizedPnl: "0",
        marginAsset: "USDT",
        quoteQty: "49.02583",
        commission: "0.01961033",
        commissionAsset: "USDT",
        time: 1640871982554,
        positionSide: "BOTH",
        buyer: false,
        maker: false,
      },
      {
        symbol: "SXPUSDT",
        id: 195505841,
        orderId: 8095143271,
        side: "SELL",
        price: "1.8572",
        qty: "26.3",
        realizedPnl: "0",
        marginAsset: "USDT",
        quoteQty: "48.84436",
        commission: "0.01953774",
        commissionAsset: "USDT",
        time: 1640872019650,
        positionSide: "BOTH",
        buyer: false,
        maker: false,
      },
      {
        symbol: "SXPUSDT",
        id: 195509438,
        orderId: 8095086377,
        side: "BUY",
        price: "1.8480",
        qty: "26.3",
        realizedPnl: "0.36907666",
        marginAsset: "USDT",
        quoteQty: "48.60240",
        commission: "0.00972048",
        commissionAsset: "USDT",
        time: 1640872032348,
        positionSide: "BOTH",
        buyer: true,
        maker: true,
      },
      {
        symbol: "SXPUSDT",
        id: 195510754,
        orderId: 8095085264,
        side: "BUY",
        price: "1.8410",
        qty: "26.3",
        realizedPnl: "0.55317666",
        marginAsset: "USDT",
        quoteQty: "48.41830",
        commission: "0.00968366",
        commissionAsset: "USDT",
        time: 1640872034237,
        positionSide: "BOTH",
        buyer: true,
        maker: true,
      },
      {
        symbol: "SXPUSDT",
        id: 195511819,
        orderId: 8095164867,
        side: "BUY",
        price: "1.8490",
        qty: "26.3",
        realizedPnl: "0.34277666",
        marginAsset: "USDT",
        quoteQty: "48.62870",
        commission: "0.00972574",
        commissionAsset: "USDT",
        time: 1640872036170,
        positionSide: "BOTH",
        buyer: true,
        maker: true,
      },
    ];
    const trades = tradeAggregator(rawTrades);
    expect(trades).eql([
      {
        closeTime: 1640872036170,
        fee: "$0.09",
        openTime: 1640871981131,
        priceChangeInPercent: "0.87%",
        priceClose: "$1.846",
        priceOpen: "$1.862",
        profit: "$1.18",
        quantity: "78.9",
        side: "SHORT",
        symbol: "SXPUSDT",
        volume: "$146.91",
      },
    ]);
  });

  it("One profitable trade to sell and another profitable trade to buy", () => {
    const rawTrades = [
      {
        symbol: "SXPUSDT",
        id: 195501326,
        orderId: 8095119826,
        side: "SELL",
        price: "1.8648",
        qty: "26.3",
        realizedPnl: "0",
        marginAsset: "USDT",
        quoteQty: "49.04424",
        commission: "0.01961769",
        commissionAsset: "USDT",
        time: 1640871981131,
        positionSide: "BOTH",
        buyer: false,
        maker: false,
      },
      {
        symbol: "SXPUSDT",
        id: 195511819,
        orderId: 8095164867,
        side: "BUY",
        price: "1.8490",
        qty: "26.3",
        realizedPnl: "0.34277666",
        marginAsset: "USDT",
        quoteQty: "48.62870",
        commission: "0.00972574",
        commissionAsset: "USDT",
        time: 1640872036170,
        positionSide: "BOTH",
        buyer: true,
        maker: true,
      },
      {
        symbol: "NKNUSDT",
        id: 57856665,
        orderId: 1243901519,
        side: "BUY",
        price: "0.37820",
        qty: "132",
        realizedPnl: "0",
        marginAsset: "USDT",
        quoteQty: "49.92240",
        commission: "0.00998448",
        commissionAsset: "USDT",
        time: 1640945904886,
        positionSide: "BOTH",
        buyer: true,
        maker: true,
      },
      {
        symbol: "NKNUSDT",
        id: 57858773,
        orderId: 1243921202,
        side: "SELL",
        price: "0.38080",
        qty: "132",
        realizedPnl: "0.34320000",
        marginAsset: "USDT",
        quoteQty: "50.26560",
        commission: "0.01005312",
        commissionAsset: "USDT",
        time: 1640947616268,
        positionSide: "BOTH",
        buyer: false,
        maker: true,
      },
    ];
    const trades = tradeAggregator(rawTrades);
    expect(trades).eql([
      {
        closeTime: 1640872036170,
        fee: "$0.03",
        openTime: 1640871981131,
        priceChangeInPercent: "0.85%",
        priceClose: "$1.849",
        priceOpen: "$1.8648",
        profit: "$0.31",
        quantity: "26.3",
        side: "SHORT",
        symbol: "SXPUSDT",
        volume: "$49.04",
      },
      {
        closeTime: 1640947616268,
        fee: "$0.02",
        openTime: 1640945904886,
        priceChangeInPercent: "0.69%",
        priceClose: "$0.3808",
        priceOpen: "$0.3782",
        profit: "$0.32",
        quantity: "132",
        side: "LONG",
        symbol: "NKNUSDT",
        volume: "$49.92",
      },
    ]);
  });
});
